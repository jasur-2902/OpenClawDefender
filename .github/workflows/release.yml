name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS Universal Binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-release-

      - name: Build aarch64
        run: |
          cargo build --release --target aarch64-apple-darwin --package clawdefender-cli
          cargo build --release --target aarch64-apple-darwin --package clawdefender-daemon

      - name: Build x86_64
        run: |
          cargo build --release --target x86_64-apple-darwin --package clawdefender-cli
          cargo build --release --target x86_64-apple-darwin --package clawdefender-daemon

      - name: Create universal binaries
        run: |
          mkdir -p target/universal-apple-darwin/release
          lipo -create \
            target/aarch64-apple-darwin/release/clawdefender \
            target/x86_64-apple-darwin/release/clawdefender \
            -output target/universal-apple-darwin/release/clawdefender
          lipo -create \
            target/aarch64-apple-darwin/release/clawdefender-daemon \
            target/x86_64-apple-darwin/release/clawdefender-daemon \
            -output target/universal-apple-darwin/release/clawdefender-daemon

      - name: Ad-hoc code sign
        run: |
          codesign --sign - --force target/universal-apple-darwin/release/clawdefender
          codesign --sign - --force target/universal-apple-darwin/release/clawdefender-daemon

      - name: Create tarball and checksum
        run: |
          cd target/universal-apple-darwin/release
          tar czf clawdefender-macos-universal.tar.gz clawdefender clawdefender-daemon
          shasum -a 256 clawdefender-macos-universal.tar.gz > clawdefender-macos-universal.tar.gz.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/universal-apple-darwin/release/clawdefender-macos-universal.tar.gz
            target/universal-apple-darwin/release/clawdefender-macos-universal.tar.gz.sha256
          generate_release_notes: true

      # ------------------------------------------------------------------
      # Apple Developer ID signing (uncomment when certs are configured)
      # ------------------------------------------------------------------
      # - name: Import signing certificate
      #   env:
      #     CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
      #     CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
      #   run: |
      #     echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
      #     security create-keychain -p "" build.keychain
      #     security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
      #     security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
      #     security default-keychain -s build.keychain

      # - name: Code sign with Developer ID
      #   run: |
      #     codesign --sign "Developer ID Application: ${{ secrets.APPLE_TEAM_NAME }}" \
      #       --options runtime \
      #       --timestamp \
      #       target/universal-apple-darwin/release/clawdefender
      #     codesign --sign "Developer ID Application: ${{ secrets.APPLE_TEAM_NAME }}" \
      #       --options runtime \
      #       --timestamp \
      #       target/universal-apple-darwin/release/clawdefender-daemon

      # - name: Notarize binaries
      #   run: |
      #     cd target/universal-apple-darwin/release
      #     zip clawdefender.zip clawdefender clawdefender-daemon
      #     xcrun notarytool submit clawdefender.zip \
      #       --apple-id "${{ secrets.APPLE_ID }}" \
      #       --password "${{ secrets.APPLE_APP_PASSWORD }}" \
      #       --team-id "${{ secrets.APPLE_TEAM_ID }}" \
      #       --wait
      #     xcrun stapler staple clawdefender
      #     xcrun stapler staple clawdefender-daemon
